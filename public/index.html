<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>URL Shortener</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    form {
      margin-bottom: 20px;
    }
    input[type="text"] {
      width: 70%;
      padding: 8px;
    }
    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    #result {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      display: none;
    }
    #urlList {
      margin-top: 20px;
    }
    .url-item {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
    }
    .actions {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>URL Shortener</h1>
  <form id="shortenForm">
    <input type="text" id="urlInput" placeholder="Enter URL to shorten (e.g., https://example.com)" required />
    <button type="submit">Shorten URL</button>
  </form>

  <div id="result"></div>
  <h2>Your Shortened URLs</h2>
  <div id="urlList"></div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const shortenForm = document.getElementById("shortenForm");
      const urlInput = document.getElementById("urlInput");
      const resultDiv = document.getElementById("result");
      const urlListDiv = document.getElementById("urlList");

      loadSavedUrls();

      shortenForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const url = urlInput.value.trim();
        if (!url) return;

        try {
          const response = await fetch("/shorten", {
            method: "POST",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ url })
          });

          if (!response.ok) throw new Error("Failed to shorten URL");
          const data = await response.json();

          resultDiv.style.display = "block";
          resultDiv.innerHTML = `
            <p>Original URL: ${data.url}</p>
            <p>Short URL: <a href="/${data.short_code}" target="_blank">${window.location.origin}/${data.short_code}</a></p>
          `;

          saveUrl(data);
          loadSavedUrls();
          urlInput.value = "";
        } catch (error) {
          console.error(error);
          resultDiv.style.display = "block";
          resultDiv.innerHTML = `<p>Error: ${error.message}</p>`;
        }
      });

      function saveUrl(urlData) {
        const savedUrls = JSON.parse(localStorage.getItem("shortUrls") || "[]");
        const index = savedUrls.findIndex((url) => url.short_code === urlData.short_code);
        if (index !== -1) {
          savedUrls[index] = urlData;
        } else {
          savedUrls.push(urlData);
        }
        localStorage.setItem("shortUrls", JSON.stringify(savedUrls));
      }

      function removeUrl(shortCode) {
        const savedUrls = JSON.parse(localStorage.getItem("shortUrls") || "[]");
        const updated = savedUrls.filter((url) => url.short_code !== shortCode);
        localStorage.setItem("shortUrls", JSON.stringify(updated));
      }

      function loadSavedUrls() {
        const savedUrls = JSON.parse(localStorage.getItem("shortUrls") || "[]");
        urlListDiv.innerHTML = savedUrls.length
          ? ""
          : "<p>No URLs yet. Shorten some URLs to see them here.</p>";

        savedUrls.forEach((urlData) => {
          const item = document.createElement("div");
          item.className = "url-item";
          const shortUrl = `${window.location.origin}/${urlData.short_code}`;
          item.innerHTML = `
            <p>Original URL: ${urlData.url}</p>
            <p>Short URL: <a href="/${urlData.short_code}" target="_blank">${shortUrl}</a></p>
            <p>Created: ${new Date(urlData.created_at).toLocaleString()}</p>
            <div class="actions">
              <button class="stats-btn" data-code="${urlData.short_code}">View Stats</button>
              <button class="edit-btn" data-code="${urlData.short_code}">Edit</button>
              <button class="delete-btn" data-code="${urlData.short_code}">Delete</button>
            </div>
            <div class="stats-container" id="stats-${urlData.short_code}" style="display:none;"></div>
            <div class="edit-container" id="edit-${urlData.short_code}" style="display:none;">
              <form class="edit-form" data-code="${urlData.short_code}">
                <input type="text" class="edit-url-input" value="${urlData.url}" required />
                <button type="submit">Update</button>
                <button type="button" class="cancel-btn">Cancel</button>
              </form>
            </div>
          `;
          urlListDiv.appendChild(item);
        });

        addEventListeners();
      }

      function addEventListeners() {
        document.querySelectorAll(".stats-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            const shortCode = btn.getAttribute("data-code");
            const statsDiv = document.getElementById(`stats-${shortCode}`);
            statsDiv.style.display = statsDiv.style.display === "block" ? "none" : "block";

            try {
              const response = await fetch(`/shorten/${shortCode}/stats`);
              if (!response.ok) throw new Error("Failed to get stats");
              const data = await response.json();
              statsDiv.innerHTML = `
                <p>Access Count: ${data.access_count}</p>
                <p>Last Updated: ${new Date(data.updated_at).toLocaleString()}</p>
              `;
            } catch (error) {
              console.error(error);
              statsDiv.innerHTML = `<p>Error: ${error.message}</p>`;
            }
          });
        });

        document.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const shortCode = btn.getAttribute("data-code");
            const editDiv = document.getElementById(`edit-${shortCode}`);
            editDiv.style.display = editDiv.style.display === "block" ? "none" : "block";
          });
        });

        document.querySelectorAll(".cancel-btn").forEach((btn) => {
          btn.addEventListener("click", () => {
            const editDiv = btn.closest(".edit-container");
            editDiv.style.display = "none";
          });
        });

        document.querySelectorAll(".edit-form").forEach((form) => {
          form.addEventListener("submit", async (e) => {
            e.preventDefault();
            const shortCode = form.getAttribute("data-code");
            const newUrl = form.querySelector(".edit-url-input").value.trim();
            if (!newUrl) return;

            try {
              const response = await fetch(`/shorten/${shortCode}`, {
                method: "PUT",
                headers: {
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({ url: newUrl })
              });
              if (!response.ok) throw new Error("Failed to update URL");
              const data = await response.json();
              saveUrl(data);
              loadSavedUrls();
            } catch (error) {
              console.error(error);
              alert(`Error: ${error.message}`);
            }
          });
        });

        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", async () => {
            if (!confirm("Are you sure you want to delete this URL?")) return;
            const shortCode = btn.getAttribute("data-code");

            try {
              const response = await fetch(`/shorten/${shortCode}`, {
                method: "DELETE"
              });
              if (!response.ok) throw new Error("Failed to delete URL");
              removeUrl(shortCode);
              loadSavedUrls();
            } catch (error) {
              console.error(error);
              alert(`Error: ${error.message}`);
            }
          });
        });
      }
    });
  </script>
</body>
</html>
