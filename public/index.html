<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>URL Shortener</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
    }
    form {
      margin-bottom: 20px;
    }
    input[type="text"] {
      width: 70%;
      padding: 8px;
    }
    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      cursor: pointer;
    }
    #result {
      margin-top: 20px;
      padding: 10px;
      border: 1px solid #ddd;
      display: none;
    }
    #urlList {
      margin-top: 20px;
    }
    .url-item {
      border: 1px solid #ddd;
      padding: 10px;
      margin-bottom: 10px;
    }
    .actions {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>URL Shortener</h1>
  
  <form id="shortenForm">
    <input type="text" id="urlInput" placeholder="Enter URL to shorten (e.g., https://www.example.com)" required>
    <button type="submit">Shorten URL</button>
  </form>
  
  <div id="result"></div>
  
  <h2>Your Shortened URLs</h2>
  <div id="urlList"></div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const shortenForm = document.getElementById('shortenForm');
      const urlInput = document.getElementById('urlInput');
      const resultDiv = document.getElementById('result');
      const urlListDiv = document.getElementById('urlList');
      
      // Load saved URLs from localStorage
      loadSavedUrls();
      
      shortenForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const url = urlInput.value.trim();
        
        if (!url) return;
        
        try {
          const response = await fetch('/shorten', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ url })
          });
          
          if (!response.ok) {
            throw new Error('Failed to shorten URL');
          }
          
          const data = await response.json();
          
          // Display result
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = `
            <p>Original URL: ${data.url}</p>
            <p>Short URL: <a href="/${data.shortCode}" target="_blank">${window.location.origin}/${data.shortCode}</a></p>
          `;
          
          // Save to localStorage
          saveUrl(data);
          
          // Reload URL list
          loadSavedUrls();
          
          // Clear input
          urlInput.value = '';
        } catch (error) {
          console.error(error);
          resultDiv.style.display = 'block';
          resultDiv.innerHTML = `<p>Error: ${error.message}</p>`;
        }
      });
      
      function saveUrl(urlData) {
        const savedUrls = JSON.parse(localStorage.getItem('shortUrls') || '[]');
        
        // Check if shortCode already exists
        const existingIndex = savedUrls.findIndex(url => url.shortCode === urlData.shortCode);
        
        if (existingIndex !== -1) {
          // Update existing entry
          savedUrls[existingIndex] = urlData;
        } else {
          // Add new entry
          savedUrls.push(urlData);
        }
        
        localStorage.setItem('shortUrls', JSON.stringify(savedUrls));
      }
      
      function removeUrl(shortCode) {
        const savedUrls = JSON.parse(localStorage.getItem('shortUrls') || '[]');
        const updatedUrls = savedUrls.filter(url => url.shortCode !== shortCode);
        localStorage.setItem('shortUrls', JSON.stringify(updatedUrls));
      }
      
      function loadSavedUrls() {
        const savedUrls = JSON.parse(localStorage.getItem('shortUrls') || '[]');
        
        if (savedUrls.length === 0) {
          urlListDiv.innerHTML = '<p>No URLs yet. Shorten some URLs to see them here.</p>';
          return;
        }
        
        urlListDiv.innerHTML = '';
        
        savedUrls.forEach(urlData => {
          const urlItem = document.createElement('div');
          urlItem.className = 'url-item';
          
          const shortUrl = `${window.location.origin}/${urlData.shortCode}`;
          
          urlItem.innerHTML = `
            <p>Original URL: ${urlData.url}</p>
            <p>Short URL: <a href="/${urlData.shortCode}" target="_blank">${shortUrl}</a></p>
            <p>Created: ${new Date(urlData.createdAt).toLocaleString()}</p>
            <div class="actions">
              <button class="stats-btn" data-code="${urlData.shortCode}">View Stats</button>
              <button class="edit-btn" data-code="${urlData.shortCode}">Edit</button>
              <button class="delete-btn" data-code="${urlData.shortCode}">Delete</button>
            </div>
            <div class="stats-container" id="stats-${urlData.shortCode}" style="display:none;"></div>
            <div class="edit-container" id="edit-${urlData.shortCode}" style="display:none;">
              <form class="edit-form" data-code="${urlData.shortCode}">
                <input type="text" class="edit-url-input" value="${urlData.url}" required>
                <button type="submit">Update</button>
                <button type="button" class="cancel-btn">Cancel</button>
              </form>
            </div>
          `;
          
          urlListDiv.appendChild(urlItem);
        });
        
        // Add event listeners for buttons
        document.querySelectorAll('.stats-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const shortCode = btn.getAttribute('data-code');
            const statsContainer = document.getElementById(`stats-${shortCode}`);
            
            // Toggle display
            if (statsContainer.style.display === 'block') {
              statsContainer.style.display = 'none';
              return;
            }
            
            try {
              const response = await fetch(`/shorten/${shortCode}/stats`);
              
              if (!response.ok) {
                throw new Error('Failed to get stats');
              }
              
              const data = await response.json();
              
              statsContainer.style.display = 'block';
              statsContainer.innerHTML = `
                <p>Access Count: ${data.accessCount}</p>
                <p>Last Updated: ${new Date(data.updatedAt).toLocaleString()}</p>
              `;
            } catch (error) {
              console.error(error);
              statsContainer.style.display = 'block';
              statsContainer.innerHTML = `<p>Error: ${error.message}</p>`;
            }
          });
        });
        
        document.querySelectorAll('.edit-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const shortCode = btn.getAttribute('data-code');
            const editContainer = document.getElementById(`edit-${shortCode}`);
            
            // Toggle display
            editContainer.style.display = editContainer.style.display === 'block' ? 'none' : 'block';
          });
        });
        
        document.querySelectorAll('.cancel-btn').forEach(btn => {
          btn.addEventListener('click', () => {
            const editContainer = btn.closest('.edit-container');
            editContainer.style.display = 'none';
          });
        });
        
        document.querySelectorAll('.edit-form').forEach(form => {
          form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const shortCode = form.getAttribute('data-code');
            const newUrl = form.querySelector('.edit-url-input').value.trim();
            
            if (!newUrl) return;
            
            try {
              const response = await fetch(`/shorten/${shortCode}`, {
                method: 'PUT',
                headers: {
                  'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url: newUrl })
              });
              
              if (!response.ok) {
                throw new Error('Failed to update URL');
              }
              
              const data = await response.json();
              
              // Update localStorage
              saveUrl(data);
              
              // Reload URL list
              loadSavedUrls();
              
              // Show success message
              const editContainer = form.closest('.edit-container');
              editContainer.style.display = 'none';
            } catch (error) {
              console.error(error);
              alert(`Error: ${error.message}`);
            }
          });
        });
        
        document.querySelectorAll('.delete-btn').forEach(btn => {
          btn.addEventListener('click', async () => {
            if (!confirm('Are you sure you want to delete this URL?')) {
              return;
            }
            
            const shortCode = btn.getAttribute('data-code');
            
            try {
              const response = await fetch(`/shorten/${shortCode}`, {
                method: 'DELETE'
              });
              
              if (!response.ok) {
                throw new Error('Failed to delete URL');
              }
              
              // Remove from localStorage
              removeUrl(shortCode);
              
              // Reload URL list
              loadSavedUrls();
            } catch (error) {
              console.error(error);
              alert(`Error: ${error.message}`);
            }
          });
        });
      }
    });
  </script>
</body>
</html>